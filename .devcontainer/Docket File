# syntax=docker/dockerfile:1.4
# File: Dockerfile

# === STAGE 1: BUILD and LICENSE SCAN ===
# This stage installs development tools, runs security/license scans, and compiles if needed.
FROM python:3.11.8-slim-buster AS build

# Use ARG for build configuration, NOT secrets (Source 1.3, 4.1)
ARG USERNAME=vscode
ARG USER_UID=1000
ARG USER_GID=$USER_UID

# Install core utilities and setup the non-root user
RUN groupadd --gid $USER_GID $USERNAME \
    && useradd -s /bin/bash --uid $USER_UID --gid $USER_GID -m $USERNAME \
    && apt-get update \
    && apt-get install -y --no-install-recommends git curl build-essential \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /home/$USERNAME/SDKP_Project
USER $USERNAME
COPY . .

# Install Dependencies (including security tools/linters in this stage)
RUN pip install --no-cache-dir -r requirements.txt

# === CRITICAL: AUTOMATED LICENSE SCAN & SBOM GENERATION ===
# Recommended: Use Syft/Grype/Trivy to generate a Software Bill of Materials (SBOM)
# and collect licenses needed for the /licenses directory for auditing (Source 3.2).
# This is a placeholder; a real implementation requires installing and running the tool.
RUN echo "Running automated license scan and SBOM generation..." \
    && mkdir -p /tmp/sdkp-artifacts/licenses

# === STAGE 2: FINAL MINIMAL RUNTIME ===
# This image contains ONLY the runtime code and minimal dependencies.
FROM python:3.11.8-slim-buster AS final

# === Metadata and Legal Labels ===
LABEL org.opencontainers.image.authors="Donald Paul Smith (FatherTimeSDKP)"
LABEL org.opencontainers.image.vendor="SDKP Foundation"
LABEL org.opencontainers.image.licenses="PROPRIETARY & CONFIDENTIAL - See /licenses"

# Set non-root user from the build stage (Source 1.2)
ARG USERNAME=vscode
ARG USER_UID=1000
RUN groupadd --gid $USER_GID $USERNAME \
    && useradd -s /bin/bash --uid $USER_UID --gid $USER_GID -m $USERNAME \
    && apt-get update && apt-get install -y --no-install-recommends curl \
    && rm -rf /var/lib/apt/lists/*
WORKDIR /home/$USERNAME/SDKP_Project
USER $USERNAME

# Copy only the compiled/built code and necessary Python libraries
COPY --from=build --chown=$USERNAME:$USERNAME /home/$USERNAME/SDKP_Project /home/$USERNAME/SDKP_Project
# Copy the generated license files from the build stage
COPY --from=build /tmp/sdkp-artifacts/licenses /licenses/third-party

# Set the entrypoint to run the main SDKP application
# Replace 'sdkp_main.py' with your actual entry file
ENTRYPOINT ["python", "sdkp_main.py"]
